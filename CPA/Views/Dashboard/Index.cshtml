@model CPA.Models.DashboardViewModel

@{
    ViewData["Title"] = "Dashboard";
}

<div class="container mt-1">
    <h1 class="display-4 text-center">Welcome, @ViewBag.FirstName, to your Dashboard</h1>

    <!-- External search input -->
    <div class="form-group">
        <label for="externalSearch">Search by Nombre or Nombre Comercial:</label>
        <input type="text" id="externalSearch" class="form-control" placeholder="Enter search term...">
    </div>

    <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link active" id="demograficos-tab" data-toggle="tab" href="#demograficos" role="tab" aria-controls="demograficos" aria-selected="true">Demograficos</a>
        </li>
        <!-- Other tabs -->
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="contributivos-tab" data-toggle="tab" href="#contributivos" role="tab" aria-controls="contributivos" aria-selected="false">Contributivos</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="administrativos-tab" data-toggle="tab" href="#administrativos" role="tab" aria-controls="administrativos" aria-selected="false">Administrativos</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="identificacion-tab" data-toggle="tab" href="#identificacion" role="tab" aria-controls="identificacion" aria-selected="false">Identificacion</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="metodo-de-pago-tab" data-toggle="tab" href="#metodo-de-pago" role="tab" aria-controls="metodo-de-pago" aria-selected="false">Metodo de Pago</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="confidencial-tab" data-toggle="tab" href="#confidencial" role="tab" aria-controls="confidencial" aria-selected="false">Confidencial</a>
        </li>
    </ul>
    <!-- Demograficos tab contents -->
    <div class="tab-content" id="dashboardTabsContent">
        <div class="tab-pane fade show active" id="demograficos" role="tabpanel" aria-labelledby="demograficos-tab">
            <div id="tblDataWrapper" class="dataTableWrapper">
                @foreach (var item in Model.Demograficos)
                {
                    <table class="table table-striped table-bordered tblData" data-nombre="@item.Nombre" data-nombrecomercial="@item.NombreComercial">
                        <tbody>
                            <tr><th>Nombre</th><td>@item.Nombre</td></tr>
                            <tr><th>Nombre Comercial</th><td>@item.NombreComercial</td></tr>
                            <tr><th>Teléfono</th><td>@item.Telefono</td></tr>
                            <tr><th>Celular</th><td>@item.Celular</td></tr>
                            <tr><th>Dirección</th><td>@item.Dir</td></tr>
                            <tr><th>Tipo</th><td>@item.Tipo</td></tr>
                            <tr><th>Patronal</th><td>@item.Patronal</td></tr>
                            <tr><th>SSN</th><td>@item.SSN</td></tr>
                            <tr><th>Incorporacion</th><td>@item.Incorporacion</td></tr>
                            <tr><th>Operaciones</th><td>@item.Operaciones</td></tr>
                            <tr><th>Industria</th><td>@item.Industria</td></tr>
                            <tr><th>NAICS</th><td>@item.NAICS</td></tr>
                            <tr><th>Descripcion</th><td>@item.Descripcion</td></tr>
                            <tr><th>Contacto</th><td>@item.Contacto</td></tr>
                            <tr><th>DirFisica</th><td>@item.DirFisica</td></tr>
                            <tr><th>DirPostal</th><td>@item.DirPostal</td></tr>
                            <tr><th>Email</th><td>@item.Email</td></tr>
                            <tr><th>Email2</th><td>@item.Email2</td></tr>
                        </tbody>
                    </table>
                }
            </div>
        </div>
        <!-- Contributivos tab contents -->
        <div class="tab-pane fade" id="contributivos" role="tabpanel" aria-labelledby="contributivos-tab">
            <div id="tblDataWrapper" class="dataTableWrapper">
                @foreach (var item in Model.Contributivos)
                {
                    <table class="table table-striped table-bordered tblData" data-nombre="@item.Nombre" data-nombrecomercial="@item.NombreComercial">
                        <tbody>
                            <tr><th>Nombre</th><td>@item.Nombre</td></tr>
                            <tr><th>Nombre Comercial</th><td>@item.NombreComercial</td></tr>
                            <tr><th>Registro Estatal</th><td>@item.Estatal</td></tr>
                            <tr><th>Número de Poliza</th><td>@item.Poliza</td></tr>
                            <tr><th>Registro de Comerciante</th><td>@item.RegComerciante</td></tr>
                            <tr><th>Fecha de Vencimiento</th><td>@item.Vencimiento</td></tr>
                            <tr><th>Registro Choferil</th><td>@item.Choferil</td></tr>
                            <tr><th>Departamento de Estado</th><td>@item.DeptEstado</td></tr>
                        </tbody>
                    </table>
                }
            </div>
        </div>
        <!-- Administrativos tab contents -->
        <div class="tab-pane fade" id="administrativos" role="tabpanel" aria-labelledby="administrativos-tab">
            <div id="tblDataWrapper" class="dataTableWrapper">
                @foreach (var item in Model.Administrativos)
                {
                    <table class="table table-striped table-bordered tblData" data-nombre="@item.Nombre" data-nombrecomercial="@item.NombreComercial">
                        <tbody>
                            <tr><th>Nombre</th><td>@item.Nombre</td></tr>
                            <tr><th>Nombre Comercial</th><td>@item.NombreComercial</td></tr>
                            <tr><th>Fecha de Contrato</th><td>@item.Facturacion</td></tr>
                            <tr><th>Número de Facturación</th><td>@item.FacturacionBase</td></tr>
                            <tr><th>IVU</th><td>@item.IVU</td></tr>
                            <tr><th>Staff</th><td>@item.Staff</td></tr>
                            <tr><th>Contratación de Staff</th><td>@item.StaffDate</td></tr>
                        </tbody>
                    </table>
                }
            </div>
        </div>
        <!-- Other tab contents -->
        <div class="tab-pane fade" id="identificacion" role="tabpanel" aria-labelledby="identificacion-tab">
            <div id="tblDataWrapper" class="dataTableWrapper">
                @foreach (var item in Model.Identificaciones)
                {
                    <table class="table table-striped table-bordered tblData" data-nombre="@item.Nombre" data-nombrecomercial="@item.NombreComercial">
                        <tbody>
                            <tr><th>Nombre</th><td>@item.Nombre</td></tr>
                            <tr><th>Nombre Comercial</th><td>@item.NombreComercial</td></tr>
                            <tr><th>Accionista</th><td>@item.Accionista</td></tr>
                            <tr><th>SSNA</th><td>@item.SSNA</td></tr>
                            <tr><th>Cargo</th><td>@item.Cargo</td></tr>
                            <tr><th>Licencia de Conducir</th><td>@item.LicConducir</td></tr>
                            <tr><th>Fecha de Nacimiento</th><td>@item.Nacimiento</td></tr>
                        </tbody>
                    </table>
                }
            </div>
        </div>
        <!-- Other tab contents -->
        <div class="tab-pane fade" id="metodo-de-pago" role="tabpanel" aria-labelledby="metodo-de-pago-tab">
            <div id="tblDataWrapper" class="dataTableWrapper">
                @foreach (var item in Model.Pagos)
                {
                    <table class="table table-striped table-bordered tblData" data-nombre="@item.Nombre" data-nombrecomercial="@item.NombreComercial">
                        <tbody>
                            <tr><th>Nombre</th><td>@item.Nombre</td></tr>
                            <tr><th>Nombre Comercial</th><td>@item.NombreComercial</td></tr>
                            <tr><th>Cliente del Banco</th><td>@item.BankClient</td></tr>
                            <tr><th>Banco</th><td>@item.Banco</td></tr>
                            <tr><th>Numero de Ruta</th><td>@item.NumRuta</td></tr>
                            <tr><th>Nombre del Banco</th><td>@item.NameBank</td></tr>
                            <tr><th>Tipo de Cuenta</th><td>@item.TipoCuenta</td></tr>
                            <tr><th>Cliente del Banco 2</th><td>@item.BankClientS</td></tr>
                            <tr><th>Banco 2</th><td>@item.BancoS</td></tr>
                            <tr><th>Numero de Ruta 2</th><td>@item.NumRutaS</td></tr>
                            <tr><th>Nombre del Banco 2</th><td>@item.NameBankS</td></tr>
                            <tr><th>Tipo de Cuenta 2</th><td>@item.TipoCuentaS</td></tr>
                            <tr><th>Cliente en Tarjeta</th><td>@item.NameCard</td></tr>
                            <tr><th>Tarjeta de Pago</th><td>@item.Tarjeta</td></tr>
                            <tr><th>Tipo de Tarjeta</th><td>@item.TipoTarjeta</td></tr>
                            <tr><th>CVV</th><td>@item.CVV</td></tr>
                            <tr><th>Fecha Expiracion</th><td>@item.Expiracion</td></tr>
                            <tr><th>Postal en Tarjeta</th><td>@item.PostalBank</td></tr>
                            <tr><th>Cliente en Tarjeta 2</th><td>@item.NameCardS</td></tr>
                            <tr><th>Tarjeta de Pago 2</th><td>@item.TarjetaS</td></tr>
                            <tr><th>Tipo de Tarjeta 2</th><td>@item.TipoTarjetaS</td></tr>
                            <tr><th>CVVS</th><td>@item.CVVS</td></tr>
                            <tr><th>Fecha Expiracion 2</th><td>@item.ExpiracionS</td></tr>
                            <tr><th>Postal en Tarjeta 2</th><td>@item.PostalBankS</td></tr>
                        </tbody>
                    </table>
                }
            </div>
        </div>
        <!-- Other tab contents -->
        <div class="tab-pane fade" id="confidencial" role="tabpanel" aria-labelledby="confidencial-tab">
            <div id="tblDataWrapper" class="dataTableWrapper">
                @foreach (var item in Model.Confidenciales)
                {
                    <table class="table table-striped table-bordered tblData" data-nombre="@item.Nombre" data-nombrecomercial="@item.NombreComercial">
                        <tbody>
                            <tr><th>Nombre</th><td>@item.Nombre</td></tr>
                            <tr><th>Nombre Comercial</th><td>@item.NombreComercial</td></tr>
                            <tr><th>Usuario Suri</th><td>@item.UserSuri</td></tr>
                            <tr><th>Contraseña Suri</th><td>@item.PassSuri</td></tr>
                            <tr><th>Usuario Eftps</th><td>@item.UserEftps</td></tr>
                            <tr><th>Contraseña Eftps</th><td>@item.PassEftps</td></tr>
                            <tr><th>PIN</th><td>@item.PIN</td></tr>
                            <tr><th>Usuario CFSE</th><td>@item.UserCFSE</td></tr>
                            <tr><th>Contraseña CFSE</th><td>@item.PassCFSE</td></tr>
                            <tr><th>Usuario Dept del Trabajo</th><td>@item.UserDept</td></tr>
                            <tr><th>Contraseñ Dept del Trabajo</th><td>@item.PassDept</td></tr>
                            <tr><th>Usuario Cofim</th><td>@item.UserCofim</td></tr>
                            <tr><th>Contraseña Cofim</th><td>@item.PassCofim</td></tr>
                            <tr><th>Usuario Municipio</th><td>@item.UserMunicipio</td></tr>
                            <tr><th>Contraseña Municipio</th><td>@item.PassMunicipio</td></tr>
                    </table>
                }
            </div>
        </div>

    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            console.log("Document is ready");

            $('#dashboardTabs a').on('click', function (e) {
                e.preventDefault();
                $(this).tab('show');
                console.log($(this).attr('id') + " tab clicked");
                prioritizeActiveTabTables($(this).attr('href'));
            });

            // Show Toastr success message if TempData contains Success
        @if (TempData["Success"] != null)
        {
            <text>
                    console.log('Showing Toastr success message');
                toastr.success('@TempData["Success"]');
            </text>
        }

                // Initialize DataTables on each table within the wrapper
                function initializeDataTables() {
                    $('.tblData').each(function () {
                        if (!$.fn.dataTable.isDataTable($(this))) {
                            $(this).DataTable({
                                "paging": true,
                                "searching": true,
                                "ordering": false,
                                "info": false, // Disable the table information display
                                "lengthMenu": [[4, -1], ["Summary", "All"]],
                                "columnDefs": [
                                    { "orderable": true, "targets": 1 }
                                ],
                                "order": [[1, 'asc']],
                                "autoWidth": false,
                                "language": {
                                    "search": "Search in this record:"
                                }
                            });
                        }
                    });
                }

            initializeDataTables();

            // External search functionality
            $('#externalSearch').on('keyup', function () {
                var searchTerm = $(this).val().toLowerCase();
                var tablesMatched = false;

                // Hide all tables and tab panes initially
                $('.tblData').closest('table').hide();
                $('.tab-pane').hide();

                // Destroy DataTables instances on all tables
                $('.tblData').each(function () {
                    if ($.fn.dataTable.isDataTable($(this))) {
                        $(this).DataTable().destroy();
                    }
                });

                // Show only the matching tables and their parent tab panes
                $('.tblData').each(function () {
                    var nombre = $(this).data('nombre').toLowerCase();
                    var nombreComercial = $(this).data('nombrecomercial').toLowerCase();
                    var parentTable = $(this).closest('table');
                    var parentTabPane = parentTable.closest('.tab-pane');

                    if (nombre.includes(searchTerm) || nombreComercial.includes(searchTerm)) {
                        parentTable.show();
                        parentTabPane.show(); // Show the parent tab pane if a match is found
                        tablesMatched = true;
                    }
                });

                // Reinitialize DataTables only on matching tables
                if (tablesMatched) {
                    $('.tblData:visible').each(function () {
                        if (!$.fn.dataTable.isDataTable($(this))) {
                            $(this).DataTable({
                                "paging": true,
                                "searching": true,
                                "ordering": false,
                                "info": false, // Disable the table information display
                                "lengthMenu": [[4, -1], ["Summary", "All"]],
                                "columnDefs": [
                                    { "orderable": true, "targets": 1 }
                                ],
                                "order": [[1, 'asc']],
                                "autoWidth": false,
                                "language": {
                                    "search": "Search in this record:"
                                }
                            });
                        }
                    });
                }

                // Show all tab panes if no match
                if (!tablesMatched) {
                    $('.tab-pane').show();
                    initializeDataTables(); // Reinitialize DataTables for all tables
                }

                // Ensure only the first tab is active if no match
                if (searchTerm === "") {
                    $('.tab-pane').removeClass('show active');
                    $('.tab-pane:first').addClass('show active');
                }
            });

            // Ensure correct tab content visibility on load
            $('#dashboardTabsContent .tab-pane').removeClass('show active');
            $('#dashboardTabsContent .tab-pane:first').addClass('show active');

            // Function to prioritize the active tab's tables
            function prioritizeActiveTabTables(activeTabId) {
                $('.tab-pane').each(function () {
                    var tabPane = $(this);
                    if (tabPane.attr('id') === activeTabId.substring(1)) {
                        tabPane.prependTo('#dashboardTabsContent');
                    }
                });
            }

            // Prioritize the first tab's tables on load
            prioritizeActiveTabTables($('#dashboardTabs a.active').attr('href'));
        });
    </script>

    <!-- Include necessary libraries -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
}

